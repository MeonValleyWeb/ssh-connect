# Function to run a command on a site
run_site_command() {
    local server_id="$1"
    local site_id="$2"
    local command="$3"
    
    local sites=$(jq -r ".[$server_id].sites" "$SERVERS_FILE")
    local domain=$(echo "$sites" | jq -r ".[$site_id].domain")
    local username=$(echo "$sites" | jq -r ".[$site_id].username")
    local path=$(echo "$sites" | jq -r ".[$site_id].path")
    local ip=$(jq -r ".[$server_id].ip" "$SERVERS_FILE")
    
    # Check for custom username in site_users.json
    if [ -f "$USER_SITES_MAPPING_FILE" ]; then
        local server_name=$(jq -r ".[$server_id].name" "$SERVERS_FILE")
        local custom_username=$(jq -r --arg server "$server_name" --arg domain "$domain" '.[$server][$domain] // ""' "$USER_SITES_MAPPING_FILE")
        if [ -n "$custom_username" ] && [ "$custom_username" != "null" ]; then
            username="$custom_username"
        fi
    fi
    
    echo -e "\n${GREEN}Running command on:${NC} $domain"
    echo -e "${GREEN}Command:${NC} $command"
    
    # For SpinupWP sites, we work directly in the /sites/domain/files directory
    ssh -t "$username@$ip" "cd $path && $command"
    
    echo -e "\n${GREEN}Command completed on:${NC} $domain\n"
    
    # Sleep briefly to make output more readable when running on multiple sites
    sleep 1
}

# Modified site management menu - simplified for Bedrock assumption
site_management_menu() {
    local server_id="$1"
    
    clear
    echo -e "${YELLOW}Site Management Menu${NC}"
    echo -e "1. Connect to a specific site"
    echo -e "2. Run command on a specific site"
    echo -e "3. Run command on all sites"
    echo -e "4. Run composer command on all sites"
    echo -e "5. Back to main menu"
    echo -e "q. Quit"
    
    echo -e "\n${CYAN}Select an option:${NC} "
    read -r option
    
    case $option in
        1)
            if select_site "$server_id"; then
                if [ "$SITE_ALL" = "true" ]; then
                    echo "Cannot connect to all sites at once. Please select a specific site."
                    sleep 2
                    site_management_menu "$server_id"
                else
                    connect_to_site "$server_id" "$SITE_ID"
                fi
            else
                site_management_menu "$server_id"
            fi
            ;;
        2)
            if select_site "$server_id"; then
                echo -e "\n${CYAN}Enter command to run:${NC} "
                read -r command
                
                if [ "$SITE_ALL" = "true" ]; then
                    local sites=$(jq -r ".[$server_id].sites" "$SERVERS_FILE")
                    local site_count=$(echo "$sites" | jq 'length')
                    
                    for i in $(seq 0 $(($site_count - 1))); do
                        run_site_command "$server_id" "$i" "$command"
                    done
                else
                    run_site_command "$server_id" "$SITE_ID" "$command"
                fi
            fi
            ;;
        3)
            echo -e "\n${CYAN}Enter command to run on all sites:${NC} "
            read -r command
            
            local sites=$(jq -r ".[$server_id].sites" "$SERVERS_FILE")
            local site_count=$(echo "$sites" | jq 'length')
            
            echo -e "\n${YELLOW}Running command on all sites...${NC}"
            
            for i in $(seq 0 $(($site_count - 1))); do
                local domain=$(echo "$sites" | jq -r ".[$i].domain")
                echo -e "Processing site: $domain"
                run_site_command "$server_id" "$i" "$command"
            done
            ;;
        4)
            echo -e "\n${CYAN}Select composer command:${NC}"
            select composer_cmd in "${COMPOSER_COMMANDS[@]}" "custom"; do
                if [ "$composer_cmd" = "custom" ]; then
                    echo -e "${CYAN}Enter custom composer command:${NC} "
                    read -r custom_cmd
                    composer_cmd="$custom_cmd"
                fi
                
                local command="composer $composer_cmd"
                
                local sites=$(jq -r ".[$server_id].sites" "$SERVERS_FILE")
                local site_count=$(echo "$sites" | jq 'length')
                
                echo -e "\n${YELLOW}Running '$command' on all sites...${NC}"
                
                for i in $(seq 0 $(($site_count - 1))); do
                    local domain=$(echo "$sites" | jq -r ".[$i].domain")
                    echo -e "Processing site: $domain"
                    run_site_command "$server_id" "$i" "$command"
                done
                
                break
            done
            ;;
        5)
            main_menu
            ;;
        q)
            echo "Goodbye!"
            exit 0
            ;;
        *)
            echo "Invalid option. Please try again."
            sleep 1
            site_management_menu "$server_id"
            ;;
    esac
}